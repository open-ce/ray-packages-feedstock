From 7197e0bbbeff04496a95436546710a96aa2b92bd Mon Sep 17 00:00:00 2001
From: Nishidha Panpaliya <npanpa23@in.ibm.com>
Date: Tue, 21 Feb 2023 01:28:44 -0500
Subject: [PATCH 7/7] Updated Protobuf to 3.19

---
 bazel/ray_deps_setup.bzl          |  7 ++--
 thirdparty/patches/protobuf.patch | 58 +++++++++++++++++++++++++++++++
 2 files changed, 62 insertions(+), 3 deletions(-)
 create mode 100644 thirdparty/patches/protobuf.patch

diff --git a/bazel/ray_deps_setup.bzl b/bazel/ray_deps_setup.bzl
index 4b332b094..c950039bd 100644
--- a/bazel/ray_deps_setup.bzl
+++ b/bazel/ray_deps_setup.bzl
@@ -88,9 +88,10 @@ def ray_deps_setup():
     # https://github.com/ray-project/ray/issues/14117
     http_archive(
         name = "com_google_protobuf",
-        strip_prefix = "protobuf-3.16.0",
-        urls = ["https://github.com/protocolbuffers/protobuf/archive/v3.16.0.tar.gz"],
-        sha256 = "7892a35d979304a404400a101c46ce90e85ec9e2a766a86041bb361f626247f5",
+        strip_prefix = "protobuf-3.19.6",
+        patches = ["@com_github_ray_project_ray//thirdparty/patches:protobuf.patch"],
+        urls = ["https://github.com/protocolbuffers/protobuf/archive/v3.19.6.tar.gz"],
+        sha256 = "9a301cf94a8ddcb380b901e7aac852780b826595075577bb967004050c835056",
     )
 
     # NOTE(lingxuan.zlx): 3rd party dependencies could be accessed, so it suggests
diff --git a/thirdparty/patches/protobuf.patch b/thirdparty/patches/protobuf.patch
new file mode 100644
index 000000000..f4be271d3
--- /dev/null
+++ b/thirdparty/patches/protobuf.patch
@@ -0,0 +1,58 @@
+From 6bff868e60ff68422230fd0ae3cc1f3644a7ab8a Mon Sep 17 00:00:00 2001
+From: Archana Shinde1 <archana.shinde2504@gmail.com>
+Date: Thu, 16 Feb 2023 06:21:47 +0000
+Subject: [PATCH] Patch protobuf
+
+---
+ BUILD                                   | 4 +++-
+ python/google/protobuf/pyext/message.cc | 4 ++++
+ 2 files changed, 7 insertions(+), 1 deletion(-)
+
+diff --git BUILD BUILD
+index 1690d4219..6c1de4a1e 100644
+--- BUILD
++++ BUILD
+@@ -19,7 +19,7 @@ exports_files(["LICENSE"])
+ # ZLIB configuration
+ ################################################################################
+ 
+-ZLIB_DEPS = ["@zlib//:zlib"]
++ZLIB_DEPS = ["@zlib"]
+ 
+ ################################################################################
+ # Protobuf Runtime Library
+@@ -196,6 +196,7 @@ cc_library(
+     copts = COPTS,
+     includes = ["src/"],
+     linkopts = LINK_OPTS,
++    alwayslink = 1,
+     visibility = ["//visibility:public"],
+ )
+ 
+@@ -269,6 +270,7 @@ cc_library(
+     copts = COPTS,
+     includes = ["src/"],
+     linkopts = LINK_OPTS,
++    alwayslink = 1,
+     visibility = ["//visibility:public"],
+     deps = [":protobuf_lite"] + PROTOBUF_DEPS,
+ )
+diff --git python/google/protobuf/pyext/message.cc python/google/protobuf/pyext/message.cc
+index cb48faa44..184e27274 100644
+--- python/google/protobuf/pyext/message.cc
++++ python/google/protobuf/pyext/message.cc
+@@ -2957,7 +2957,11 @@ bool InitProto2MessageModule(PyObject *m) {
+         reinterpret_cast<PyObject*>(&RepeatedCompositeContainer_Type));
+ 
+     // Register them as MutableSequence.
++#if PY_MAJOR_VERSION >= 3
+     ScopedPyObjectPtr collections(PyImport_ImportModule("collections.abc"));
++#else
++     ScopedPyObjectPtr collections(PyImport_ImportModule("collections"));
++#endif
+     if (collections == NULL) {
+       return false;
+     }
+-- 
+2.34.1
+
-- 
2.27.0

